<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--
CSS Custom property | Description | Default
--------------------|-------------|----------
`--qgi-font` | Font mixin for all of the elements | paper-font-default, 12px
`--qgi-radius-width` | The width of the radius dropdown. | 4em
`--qgi-unit-width` | The width of the radius-unit dropdown. | 3em
`--qgi-dropdown-icon-size` | The height and width of the dropdown menu icons. | 16px
`--qgi-search-input-width` | The width of the search input field. | 6em

`--qgi-font-small` | Mixin applied the the font of the "or" span.
`--qgi-checkbox-size` | The height and width of the checkbox. | 14px
`--qgi-checkbox-label-spacing` | Space between the checkbox and its label. | 4px
`--qgi-spacing` | The space between each element, except the two dropdowns. | 6px
`--qgi-dropdown-spacing` | The space between the radius and unit dropdowns. | 2px
-->
<dom-module id="geo-query-input">
  <template strip-whitespace>
    <style>
      :host {
        display: block;

        --qgi-font: {
          @apply --paper-font-common-base;
          font-size: 12px;
          font-weight: 400;
          /*line-height: 16px;*/
        };

        --qgi-spacing: 0.5em;
        --qgi-radius-width: 4em;
        --qgi-unit-width: 3em;
        --qgi-search-width: 6em;
        --qgi-dropdown-icon: 16px;
        --qgi-checkbox-size: 14px;

        @apply --qgi-font;
      }

      .container {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .prefix {
        margin-right: var(--qgi-spacing);
      }

      .of, .or {
        margin: 0 var(--qgi-spacing);
      }

      .radius-menu, .unit-menu {
        --paper-input-container-input: {
          text-align: right;
          @apply --qgi-font;
        };
        --paper-input-container-label: {
          text-align: right;
          @apply --qgi-font;
        };
        --iron-icon-width: var(--qgi-dropdown-icon);
        --iron-icon-height: var(--qgi-dropdown-icon);
      }
      .radius-menu {
        width: var(--qgi-radius-width);
        margin-right: calc(var(--qgi-spacing) / 2);
      }
      .unit-menu {
        width: var(--qgi-unit-width);
      }

      paper-input {
        display: inline-block;
        width: var(--qgi-search-width);
        --paper-input-container-label: {
          text-align: center;
          @apply --qgi-font;

        };
        --paper-input-container-input: {
          @apply --qgi-font;
        };
        /*--paper-input-error: {
          @apply --qgi-font;
        };*/
      }
      paper-item {
        --paper-item: {
          @apply --qgi-font;
        };
      }

      paper-checkbox {
        --paper-checkbox-size: var(--qgi-checkbox-size);
        --paper-checkbox-label-spacing: calc(var(--qgi-spacing) / 2);
      }
    </style>
    <template is="dom-if" if="[[!noStorage]]" restamp>
      <!-- FIXME multiple uses in the same page can be accomplished after https://github.com/PolymerElements/app-storage/pull/76 -->
      <!-- <app-localstorage-document
        sessionOnly="[[sessionOnly]]"
        key="[[_keyFor('radius')]]"
        data="{{radius}}"></app-localstorage-document>
      <app-localstorage-document
        sessionOnly="[[sessionOnly]]"
        key="[[_keyFor('unit')]]"
        data="{{unit}}"></app-localstorage-document>
      <app-localstorage-document
        sessionOnly="[[sessionOnly]]"
        key="[[_keyFor('search')]]"
        data="{{search}}"></app-localstorage-document>
      <app-localstorage-document
        sessionOnly="[[sessionOnly]]"
        key="[[_keyFor('useCurrentLocation')]]"
        data="{{useCurrentLocation}}"></app-localstorage-document> -->
      <app-localstorage-document
        session-only="[[sessionOnly]]"
        key="geoQueryInputRadius"
        data="{{radius}}"></app-localstorage-document>
      <app-localstorage-document
        session-only="[[sessionOnly]]"
        key="geoQueryInputUnit"
        data="{{unit}}"></app-localstorage-document>
      <app-localstorage-document
        session-only="[[sessionOnly]]"
        key="geoQueryInputSearch"
        data="{{search}}"></app-localstorage-document>
      <app-localstorage-document
        session-only="[[sessionOnly]]"
        key="geoQueryInputUseCurrentLocation"
        data="{{useCurrentLocation}}"></app-localstorage-document>
    </template>
    <div class="container">
        <span class="prefix">[[prefix]]</span>
        <paper-dropdown-menu class="radius-menu" label="radius" no-animations noink no-label-float>
          <paper-listbox
            slot="dropdown-content"
            attr-for-selected="value"
            selected="{{radius}}">
            <template is="dom-repeat" items="[[radiusOptions]]">
              <paper-item value="[[item]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu class="unit-menu" label="unit" no-animations noink no-label-float>
          <paper-listbox
            slot="dropdown-content"
            attr-for-selected="value"
            selected="{{unit}}">
            <paper-item value="km">km</paper-item>
            <paper-item value="mi">mi</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <span class="of">of</span>
        <paper-input
          id="searchInput"
          value="{{search}}"
          label="[[searchLabel]]"
          auto-validate
          no-label-float
          focused="{{searchInputFocused}}"
          minlength="3"
          error-message="[[errorMsg]]">
        </paper-input>
        <span class="or">or</span>
        <paper-checkbox id="checkbox" noink checked="{{useCurrentLocation}}">[[locationLabel]]</paper-checkbox>


        <slot name="submit-button"></slot>
    </div>
  </template>

  <script>
    /**
     * `geo-query-input`
     * Specify the center point and search radius for geographical queries.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
  Polymer({
    is: 'geo-query-input',
    properties: {
      /*
       * Text placed before the radius dropdown.
       */
      prefix: {
        type: String,
        value: 'Within'
      },
      /*
       * Current location checkbox label.
       */
      locationLabel: {
        type: String,
        value: 'my location'
      },
      /**
       * The label for the search input.
       */
      searchLabel: {
        type: String,
        value: 'search'
      },
      /**
       * Whether to use miles or kilometers ('mi' or 'km').
       */
      unit: {
        type: String,
        value: 'mi',
        notify: true
      },



      /**
       * The error message for the search input.
       */
      errorMsg: {
        type: String,
        value: '3 char min'
      },

      /**
       * The value of the search input.
       */
      search: {
        type: String,
        notify: true,
        observer: '_searchChanged'
      },

      /**
       * Whether to use the user's current location as opposed to the search input field.
       */
      useCurrentLocation: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
        notify: true,
      },

      /**
       * The distance to search from [lat, lng], in miles or kilometers depending
       * on the `unit` property.
       */
      radius: {
        type: Number,
        value: 50,
        notify: true
      },

      /**
       * The values for the radius dropdown chooser.
       */
      radiusOptions: {
        type: Array,
        value: [10, 25, 50, 100, 200]
      },

      /**
       * If true, the data will automatically be cleared from storage when
       * the page session ends (i.e. when the user has navigated away from
       * the page).
       */
      sessionOnly: {
        type: Boolean,
        value: false
      },

      /**
       * Whether to allow backup to local/session storage. Overrides sessionOnly when true
       */
      noStorage: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },

      /**
       * The number of milliseconds to wait for input changes
       * before firing `query-changed` after an input changes.
       */
      debounceDuration: {
        type: Number,
        value: 1000
      }
    },
    observers: [
      '_queryChanged(unit, radius, search, useCurrentLocation)',
      '_searchInputFocusChanged(searchInputFocused)'
    ],

    created: function() {
      // this.debouncer = new Polymer.Debouncer(this);
    },

    _searchChanged: function(search, old) {
      if (search || old) {
        this.useCurrentLocation = false;
      }
    },

    _searchInputFocusChanged: function(focused) {
      if (focused) {
        this.$.searchInput.$.input.inputElement.select();
      }
    },

    _queryChanged: function(unit, radius, search, useCurrentLocation) {
      if (radius && (useCurrentLocation || (search && this.$.searchInput.validate()))) {
        this.debounce('query-changed', function() {
          this.fire('query-changed', {
            radiusKm: unit == 'km' ? radius : (radius * 1.60934),
            search: search,
            useCurrentLocation: useCurrentLocation
          });
          this.$.searchInput.blur();
          this.$.checkbox.blur();
        }.bind(this), this.debounceDuration, this);
      }
    },

    /**
     * Return the current state of the inputs.
     */
    getCurrentQuery: function() {
      return {
        radiusKm: this.unit == 'km' ? this.radius : (this.radius * 1.60934),
        search: this.search,
        useCurrentLocation: this.useCurrentLocation,
        searchInvalid: !this.$.searchInput.validate()
      }
    },

    /** work around multiple instances in one page sharing the same local storage */
    _keyFor: function(type) {
      console.log('key:', this.id + type);
      return 'geoQueryInput' + this.id + type;
    }


    /**
     * Triggered when a user taps the submit button.
     * @event query-changed
     * @param {useCurrentLocation} boolean Whether the user's current location should be used.
     * @param {search} string The string to geocode if not using the user's current location.
     * @param {radiusKm} number The radius in kilometers to search from the center point.
     */
  });
  </script>
</dom-module>
