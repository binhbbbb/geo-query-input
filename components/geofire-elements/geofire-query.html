<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="scripts.html">
<link rel="import" href="geofire-elements-behavior.html">

<!--
`geofire-query`
An element for working with GeoFire's [`GeoQuery`](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoquery)s.

@polymerBehavior GeofireElementsBehavior
@demo demo/index.html
-->

<dom-module id="geofire-query">
  <script>
    Polymer({

      is: 'geofire-query',

      properties: {
        /**
         * The latitude for the query's center.
         */
        lat: Number,

        /**
         * The longitude for the query's center.
         */
        lng: Number,

        /**
         * The radius in kilometers around the query's center.
         */
        radius: Number,

        /**
         * Whether the query is active and listening for GeoQuery events.
         */
        idle: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
//          observer: '_idleChanged'
        },

        /**
         * An array managed by the GeoQuery events.
         * Each element is an object with properties `key, lat, lng, location, distance`.
         */
        resultsArray: {
          type: Array,
          notify: true
        },

        /**
         * An object managed by the GeoQuery events.
         * It is a map of key => {`lat, lng, location, distance`}.
         */
        resultsObject: {
          type: Object,
          notify: true
        }
      },

      observers: [
        '_idleChanged(idle, _query)',
        '_queryChanged(lat, lng, radius)'
      ],

      behaviors: [
         GeofireElementsBehavior
      ],

      _idleChanged: function(idle, query) {
        if (!query) return;
        if (!idle) {

          this.resultsArray = [];
          this.resultsObject = {};

          // Key entered event
          this.onKeyEnteredRegistration = query.on('key_entered', function(key, location, distance) {

            // Object changes
            this.resultsObject[key] = {
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            this.notifyPath('resultsObject.' + key);

            // Array changes
            var data = {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            this.push('resultsArray', data);

            this.fire('key-entered', data);
          }.bind(this));

          // Key exited event
          this.onKeyExitedRegistration = query.on("key_exited", function(key, location, distance) {

            // Object changes
            this.resultsObject[key] = null;
            this.notifyPath('resultsObject.' + key);

            // Array changes
            for (var i = 0; i < this.resultsArray.length; i++) {
              if (this.resultsArray[i].key == key) {
                this.splice('resultsArray', i, 1);
                break;
              }
            }

            this.fire('key-exited', {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            });
          }.bind(this));

          // Key moved event
          this.onKeyMovedRegistration = query.on("key_moved", function(key, location, distance) {

            // Object changes
            this.resultsObject[key] = {
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            this.notifyPath('resultsObject.' + key);

            // Array changes
            var data = {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            for (var i = 0; i < this.resultsArray.length; i++) {
              if (this.resultsArray[i].key == key) {
                this.resultsArray[i] = data;
                this.notifyPath('resultsArray.' + i);
                break;
              }
            }

            this.fire('key-moved', data);
          }.bind(this));

          // Ready event
          this.onReadyRegistration = query.on("ready", function() {
            this.fire('ready');
          }.bind(this));

        } else {
          // The query is idle, cancel event listeners and set the query to null
          // so that it can be reused.
          query.cancel();
          query = null;

          // This shouldn't be needed, but just in case.
          if (this._query) {
            this._query.cancel();
            this._query = null;
          }
        }
      },

      _queryChanged: function(lat, lng, radius) {
        if ((lat || lat === 0) && (lng || lng === 0) && radius) {
          var criteria = {
            center: [lat, lng],
            radius: radius
          };
          if (this._query) {
            this._query.updateCriteria(criteria);
          } else {
            this._query = this._geofire.query(criteria);
          }
        }
      }

      /**
       * Corresponds to the GeoQuery's `key_entered` event. Fires after updating the internal results.
       * @event key-entered
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng] shorthand.
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `key_exited` event. Fires after updating the internal results.
       * @event key-exited
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng].
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `key_moved` event. Fires after updating the internal results.
       * @event key-moved
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng].
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `ready` event. Fired when the initial result set of the query is ready.
       * @event ready
       */
    });
  </script>
</dom-module>
